<DataGrid
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:js="http://schemas.jetsun.com.cn/his/2009/presentation"
    xmlns:sys="clr-namespace:System;assembly=mscorlib"
    xmlns:cis="clr-namespace:JetSun.ClinicalManagement;assembly=ClinicalManagement"
    xmlns:op ="clr-namespace:JetSun.OPClinicalManagement.Layout;assembly=OPClinicalManagement.Layout"
    >
    <DataGrid.Resources >
        <op:DateTimeNullToStringConverter x:Key="DateTimeNullToStringConverter" />
        <op:DecimalNullToStringConverter x:Key="AmountWithNullToStringConverter" />
        <cis:TimeSpanFormattedConverter x:Key="TimeSpanFormatted" />
        <cis:OrderRequestStatusToImageConverter x:Key="OrderRequestStatusToImageSource" />
        <cis:BooleanToProblemImageConverter x:Key="BooleanToProblemToImageSource" />
        <cis:EmptyStringByteFormattedConverter x:Key="EmptyStringByteFormattedConverter" />
        <sys:String x:Key="NameCellLockedExpr">
            <![CDATA[!State.IsEntered   || !IsAllowEdit ]]>
        </sys:String>
        <sys:String x:Key="AmountCellLockedExpr">
            <![CDATA[!State.IsEntered  || !IsAllowEdit || SubstanceClass == null || SubstanceClass.Id <= 5]]>
        </sys:String>        
        <sys:String x:Key="CellHiddenExpr">
            <![CDATA[!IsParent]]>
        </sys:String>
        <sys:String x:Key="CellLockedExpr">
            <![CDATA[!IsParent || !State.IsEntered || !IsAllowEdit]]>
        </sys:String>
        <sys:String x:Key="CanSplitExpr">
            <![CDATA[!CanSplitBill|| !IsNew || !IsParent ]]>
        </sys:String>
        <sys:String x:Key="DoseSkipExpr">
            <![CDATA[Substance != null && Substance.SubstanceClass.IsMaterial]]>
        </sys:String>
        <Style x:Key="AlignmentRightStyle" TargetType="TextBlock">
            <Setter Property="HorizontalAlignment" Value="Right"/>
        </Style>
        <DataTemplate x:Key="NoteTemplate" >
            <TextBlock Text="{Binding Note}" Visibility="{Binding Converter={x:Static js:Converters.BooleanToVisibility}, ConverterParameter=true, Path=OrderKind.IsSingleInterface}"/>
        </DataTemplate>

    </DataGrid.Resources>
    <DataGrid.RowStyle>
        <Style TargetType="{x:Type DataGridRow}" js:MarkupHelper.BaseOnKey="{x:Type DataGridRow}" >
            <Style.Triggers>
                <MultiDataTrigger>
                    <MultiDataTrigger.Conditions>
                        <Condition Binding="{Binding HasCharged}" Value="true"/>
                        <Condition Binding="{Binding IsDeleted}" Value="false"/>
                    </MultiDataTrigger.Conditions>
                    <Setter Property="Foreground" Value="Red" />
                </MultiDataTrigger>
            </Style.Triggers>
        </Style>
    </DataGrid.RowStyle>
    <DataGrid.Columns>
        <DataGridTextColumn Header="序号" Width="40"
        Binding="{Binding Ordinal, Converter={StaticResource EmptyStringByteFormattedConverter}}"
        js:GridDecorator.CellHiddenCondition="{StaticResource CellHiddenExpr}" IsReadOnly="True">
        </DataGridTextColumn>
        <DataGridTemplateColumn Header="项目" Width="180" ClipboardContentBinding="{Binding Substance.Name}"
        js:GridDecorator.EditorKind="EntityPicker"
        js:GridDecorator.Binding="{Binding Substance.Name}"
        js:GridDecorator.CellLockedCondition="{StaticResource NameCellLockedExpr}">
        </DataGridTemplateColumn>
        <DataGridTextColumn Header="单价" Width="80" IsReadOnly="True" Binding="{Binding Substance.UnitPrice}" />
        <DataGridTextColumn Header="单位" Width="40" IsReadOnly="True" Binding="{Binding Substance.Uom.Name}" />
        
        <DataGridTemplateColumn Header="自负%" Width="50" IsReadOnly="True" ClipboardContentBinding="{Binding PayProportion}"
                            js:GridDecorator.MemberPath ="PayProportion">
            <DataGridTemplateColumn.CellTemplate>
                <DataTemplate>
                    <TextBlock Background="Transparent"
                     Text="{Binding PayProportion}"
                     HorizontalAlignment="Right" />
                </DataTemplate>
            </DataGridTemplateColumn.CellTemplate>
        </DataGridTemplateColumn>
        
        <DataGridTextColumn Header="数量" Width="40"
            Binding="{Binding Dose, StringFormat=0.####,UpdateSourceTrigger=LostFocus}"
                            ElementStyle="{StaticResource AlignmentRightStyle}"
                            js:GridDecorator.MaxLength="4"
            js:GridDecorator.CellLockedCondition="{StaticResource NameCellLockedExpr}"
            js:GridDecorator.CellSkipCondition="{StaticResource DoseSkipExpr}">
        </DataGridTextColumn>

        <DataGridTextColumn Header="金额" Width="75" Binding="{Binding Amount, Converter={StaticResource AmountWithNullToStringConverter}}" 
                            ElementStyle="{StaticResource AlignmentRightStyle}"
                            js:GridDecorator.MaxLength="10"
            js:GridDecorator.CellLockedCondition="{StaticResource AmountCellLockedExpr}"/>
        <DataGridTemplateColumn Header="执行科室" Width="80"   ClipboardContentBinding="{Binding ServiceOrganization.Name}" 
                js:GridDecorator.EditorKind="EntityPicker" 
                js:GridDecorator.Binding="{Binding ServiceOrganization.Name}"                 
                js:GridDecorator.CellLockedCondition="{StaticResource CellLockedExpr}">
        </DataGridTemplateColumn>
        <DataGridTextColumn Header="录入时间" Width="115" IsReadOnly="True"                             
                             Binding="{Binding InputDateTime , Converter={StaticResource DateTimeNullToStringConverter}}"></DataGridTextColumn>
        <DataGridTextColumn Header="录入者" Width="65" IsReadOnly="True" Binding="{Binding InputEmployee.Name}"></DataGridTextColumn>
    </DataGrid.Columns>
</DataGrid>