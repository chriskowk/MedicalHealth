<DataGrid  xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006" 
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008" 
             xmlns:sys="clr-namespace:System;assembly=mscorlib"
             xmlns:js="http://schemas.jetsun.com.cn/his/2009/presentation"
             xmlns:cis="clr-namespace:JetSun.OPClinicalManagement.Layout;assembly=OPClinicalManagement.Layout"
             CanUserSortColumns="False" RowDetailsVisibilityMode="VisibleWhenSelected">
    <DataGrid.Resources >
        <cis:DTModelOrdinalConverter x:Key="DTModelOrdinalConverter" />
        <cis:DTModelOrderDoseConverter x:Key="DTModelOrderDoseConverter"/>
        <cis:DTModelOrderNoteMaxLengthConverter x:Key="DTModelOrderNoteMaxLengthConverter"/>
        <cis:DTModelDaysMaxValueConverter x:Key="DTModelDaysMaxValueConverter"/>
        <cis:DTModelSubstanceStrengthConverter x:Key="DTModelSubstanceStrengthConverter"/>
        <sys:String x:Key="CellLockedExpr">
            <![CDATA[ true ]]>
        </sys:String>
        <sys:String x:Key="SubOrdinalCellHiddenExpr">
            <![CDATA[ !IsParent ]]>
        </sys:String>
        <sys:String x:Key="SubstanceLockedExpr">
            <![CDATA[ IsDeleted ]]>
        </sys:String>
        <sys:String x:Key="CellHiddenExpr">
            <![CDATA[ true ]]>
        </sys:String>
        <sys:String x:Key="ColHiddenExpr">
            <![CDATA[ true ]]>
        </sys:String>

        <sys:String x:Key="IsDoseHiddenExpr">
            <![CDATA[ false ]]>
        </sys:String>
        <sys:String x:Key="IsDoseLockedExpr">
            <![CDATA[ IsDeleted ]]>
        </sys:String>

        <Style x:Key="AlignmentRightStyle" TargetType="TextBlock">
            <Setter Property="TextAlignment" Value="Right"/>
        </Style>
        <DataTemplate x:Key="NameTemplate" >
            <StackPanel Orientation="Vertical" Margin="2">
                <StackPanel Orientation="Horizontal">
                    <TextBlock Text="{Binding SubstanceNameWithStrength}" TextWrapping="Wrap" />
                </StackPanel>
            </StackPanel>
        </DataTemplate>

        <DataTemplate x:Key="NoteTemplate" >
            <StackPanel Orientation="Vertical" Margin="2">
                <WrapPanel>
                    <TextBlock Text="{Binding Note}" TextWrapping="Wrap" />
                </WrapPanel>
            </StackPanel>
        </DataTemplate>
    </DataGrid.Resources>
    <DataGrid.RowStyle>
        <Style TargetType="{x:Type DataGridRow}" js:MarkupHelper.BaseOnKey="{x:Type DataGridRow}">
            <Style.Triggers>
                <DataTrigger Binding="{Binding Path=IsDeleted}" Value="True">
                    <Setter Property="Background" Value="{x:Static js:Markup.DeletedEntityBackground}" />
                </DataTrigger>
                <DataTrigger Binding="{Binding Path=Substance.IsDeleted}" Value="True">
                    <Setter Property="Foreground" Value="Red" />
                </DataTrigger>
                <DataTrigger Binding="{Binding Path=Substance.IPCanUsing}" Value="false">
                    <Setter Property="Foreground" Value="Red" />
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </DataGrid.RowStyle>
    <DataGrid.Columns>
        <DataGridTextColumn Header="№" Width="30" IsReadOnly="True" CanUserSort="False"
                            Binding="{Binding SubOrdinal, Converter={StaticResource DTModelOrdinalConverter}}"
                            js:GridDecorator.CellHiddenCondition="{StaticResource SubOrdinalCellHiddenExpr}"/>
        <DataGridTemplateColumn Header="材料" Width="150" 
                js:GridDecorator.EditorKind="EntityPicker" 
                js:GridDecorator.Binding="{Binding Substance.Name}" 
                js:GridDecorator.CellLockedCondition="{StaticResource SubstanceLockedExpr}"   />
        <DataGridTemplateColumn Header="规格" Width="80"                
                js:GridDecorator.Binding="{Binding Substance.Spec}" 
                js:GridDecorator.CellLockedCondition="{StaticResource CellLockedExpr}" />
        <DataGridTextColumn Header="单位" Width="40" IsReadOnly="True" Binding="{Binding Substance.DosageUnit.Name}" />
        <DataGridTextColumn  Header="数量" Binding="{Binding Dose, StringFormat=0.##,UpdateSourceTrigger=LostFocus, Converter={StaticResource DTModelOrderDoseConverter}}" 
                                js:GridDecorator.CellLockedCondition="{StaticResource IsDoseLockedExpr}"
                                js:GridDecorator.CellHiddenCondition="{StaticResource IsDoseHiddenExpr}"  ></DataGridTextColumn>
        <DataGridTextColumn Header="单价" IsReadOnly="True" Binding="{Binding Substance.UnitPrice}"/>
        <DataGridTemplateColumn Header="执行科室" Width="80"  ClipboardContentBinding="{Binding ExecuteOrganization.Name}" 
                                js:GridDecorator.EditorKind="EntityPicker" 
                                js:GridDecorator.Binding="{Binding ExecuteOrganization.Name}">
        </DataGridTemplateColumn>
    </DataGrid.Columns>
</DataGrid>
