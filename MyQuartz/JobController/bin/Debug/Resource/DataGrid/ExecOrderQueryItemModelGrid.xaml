<DataGrid
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:js="http://schemas.jetsun.com.cn/his/2009/presentation"
        xmlns:local="clr-namespace:JetSun.ClinicalManagement.Layout;assembly=ClinicalManagement.EMR" 
        xmlns:sys="clr-namespace:System;assembly=mscorlib" Background="White" HorizontalScrollBarVisibility="Auto" VerticalScrollBarVisibility="Auto" 
        IsReadOnly="True" AreRowDetailsFrozen="False" Margin="4">
    <DataGrid.Resources>
        <js:NullEmptyToVisibilityConverter x:Key="NullEmptyToVisibilityConverter" />

        <sys:String x:Key="NoDispensedMedicineCellExpr">
            <![CDATA[!Owner.OrderKind.IsSubstanceAdministration]]>
        </sys:String>

        <sys:String x:Key="DispensedNoIsTheSameCellExpr">
            <![CDATA[!Owner.OrderKind.IsSubstanceAdministration || (DispensedBillNo.Length>0 && !ctx.IsFirst && ctx.Previous.DispensedBillNo == DispensedBillNo) ]]>
        </sys:String>

        <Style TargetType="TextBlock" x:Key="LabelStyle"  >
            <Setter Property="HorizontalAlignment" Value="Right"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="FontStyle" Value="Italic"/>
            <Setter Property="Foreground" Value="DarkGreen"/>
            <Setter Property="Margin" Value="1,0,3,0" />
            <Style.Triggers>
                <DataTrigger 
                Binding="{Binding RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type DataGridCell}} , Path=(IsHidden)}" Value="true">
                    <Setter Property="Foreground" Value="Transparent"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="TextBlock" x:Key="InfoStyle">
            <Setter Property="HorizontalAlignment" Value="Left"/>
            <Setter Property="VerticalAlignment" Value="Center"/>
            <Setter Property="Margin" Value="2,0" />
            <Setter Property="TextWrapping" Value="Wrap"/>
            <Style.Triggers>
                <DataTrigger Binding="{Binding RelativeSource={RelativeSource Mode=FindAncestor, AncestorType={x:Type DataGridCell}} , Path=(IsHidden)}" Value="true">
                    <Setter Property="Foreground" Value="Transparent"/>
                </DataTrigger>
            </Style.Triggers>
        </Style>
        <Style TargetType="DataGridCell" x:Key="TCMItemPharmacyStyle" js:MarkupHelper.BaseOnKey="{x:Static js:Markup.DataGridCellStyleKey}" >
            <Style.Triggers>
                <MultiDataTrigger>
                    <MultiDataTrigger.Conditions>
                        <Condition Binding="{Binding Path=Parent.OrderKind.Id}" Value="3" />
                        <Condition Binding="{Binding Path=IsFirst}" Value="False" />
                    </MultiDataTrigger.Conditions>
                    <Setter Property="TextBlock.Foreground" Value="Transparent" />
                </MultiDataTrigger>
            </Style.Triggers>
        </Style>
    </DataGrid.Resources>

    <js:GridDecorator.SortMembers>
        <js:SortMember Member="ArrangedExecTimeEx" Direction="Ascending" />
        <js:SortMember Member="Owner.IsSupplement" Direction="Ascending" />
        <js:SortMember Member="Owner.PerformRequestItemOrderRequestId"  Direction="Ascending"  />
    </js:GridDecorator.SortMembers>

    <DataGrid.RowStyle>
        <Style TargetType="{x:Type DataGridRow}" js:MarkupHelper.BaseOnKey="{x:Type DataGridRow}">
            <Style.Triggers>
                <!--<DataTrigger Binding="{Binding Path=HasError}" Value="True">
                    <Setter Property="Foreground" Value="Red" />
                    <Setter Property="ToolTip" Value="具有差错" />
                </DataTrigger>-->
                <DataTrigger Binding="{Binding Path=PerformExecTimeStatus.IsCancel}" Value="True">
                    <Setter Property="Foreground" Value="Red" />
                </DataTrigger>
                <DataTrigger Binding="{Binding Path=IsBillHadPrinted}" Value="True">
                    <Setter Property="Foreground" Value="#FF9ACD32" />
                    <Setter Property="ToolTip" Value="申请单已经打印" />
                </DataTrigger>
                <DataTrigger Binding="{Binding Path=IsDeleted}" Value="True">
                    <Setter Property="Background" Value="#FFECEFDC" />
                    <Setter Property="ToolTip" Value="已经删除" />
                </DataTrigger>
            </Style.Triggers>
        </Style>
    </DataGrid.RowStyle>

    <DataGrid.Columns>
        <DataGridTemplateColumn Header="发药状态" MinWidth="35" Width="Auto" 
                                CellStyle="{StaticResource TCMItemPharmacyStyle}">
            <DataGridTemplateColumn.CellTemplate >
                <DataTemplate>
                    <TextBlock Text="{Binding MedicineSendStatusName}" Style="{StaticResource InfoStyle}"/>
                </DataTemplate>
            </DataGridTemplateColumn.CellTemplate>
        </DataGridTemplateColumn>

        <DataGridTemplateColumn Header="差错备注"  MinWidth="35"  Width="Auto" >
            <DataGridTemplateColumn.CellTemplate >
                <DataTemplate>
                    <TextBlock Text="{Binding ErrorNote}" Style="{StaticResource InfoStyle}"/>
                </DataTemplate>
            </DataGridTemplateColumn.CellTemplate>
        </DataGridTemplateColumn>

        <DataGridTemplateColumn Header="执行状态"  MinWidth="35"  Width="Auto" >
            <DataGridTemplateColumn.CellTemplate >
                <DataTemplate>
                    <TextBlock Text="{Binding PerfromExecTimeStatusDesc}" Style="{StaticResource InfoStyle}" TextWrapping="Wrap"/>
                </DataTemplate>
            </DataGridTemplateColumn.CellTemplate>
        </DataGridTemplateColumn>

        <DataGridTemplateColumn Header="发药信息" 
                                js:GridDecorator.CellHiddenCondition="{StaticResource DispensedNoIsTheSameCellExpr}" >
            <DataGridTemplateColumn.CellTemplate >
                <DataTemplate>
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition MinWidth="50" Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="发药时间" Style="{StaticResource LabelStyle}" Visibility="{Binding Converter={x:Static js:Converters.BooleanToVisibility}, Path=IsDispensed}"/>
                        <TextBlock Text="{Binding DispenseTime,StringFormat='yyyy-MM-dd HH:mm'}" Grid.Column="1" Style="{StaticResource InfoStyle}" Visibility="{Binding Converter={x:Static js:Converters.BooleanToVisibility}, Path=IsDispensed}"/>
                        <TextBlock Text="发药人" Grid.Row="1" Style="{StaticResource LabelStyle}" Margin="4,0" Visibility="{Binding Converter={x:Static js:Converters.BooleanToVisibility}, Path=IsDispensed}"/>
                        <TextBlock Text="{Binding DispenseEmployeeName}" Grid.Row="1" Grid.Column="1" Style="{StaticResource InfoStyle}" Visibility="{Binding Converter={x:Static js:Converters.BooleanToVisibility}, Path=IsDispensed}"/>
                        <TextBlock Text="发药单号" Grid.Row="2" Style="{StaticResource LabelStyle}" Visibility="{Binding Converter={x:Static js:Converters.BooleanToVisibility}, Path=IsDispensed}"/>
                        <TextBlock Text="{Binding DispensedBillNo}" Grid.Row="2" Grid.Column="1"  Style="{StaticResource InfoStyle}" Visibility="{Binding Converter={x:Static js:Converters.BooleanToVisibility}, Path=IsDispensed}"/>
                    </Grid>
                </DataTemplate>
            </DataGridTemplateColumn.CellTemplate>
        </DataGridTemplateColumn>
        <!--<DataGridTextColumn Header="已发药" Binding="{Binding SendMedicineDesc}" ></DataGridTextColumn>-->
        <DataGridTemplateColumn Header="药品发往" js:GridDecorator.CellHiddenCondition="{StaticResource DispensedNoIsTheSameCellExpr}">
            <DataGridTemplateColumn.CellTemplate >
                <DataTemplate>
                    <TextBlock Text="{Binding MedicineDispensedOrganizationName}" Grid.Column="1" Style="{StaticResource InfoStyle}"/>
                </DataTemplate>
            </DataGridTemplateColumn.CellTemplate>
        </DataGridTemplateColumn>
        <DataGridTextColumn Header="发药描述" Binding="{Binding SendMedicineDesc}" Width="60" FontWeight="Bold"></DataGridTextColumn>
        <DataGridTemplateColumn Header="计划执行时间">
            <DataGridTemplateColumn.CellTemplate >
                <DataTemplate>
                    <TextBlock Text="{Binding ArrangedExecTimeEx ,StringFormat='yyyy-MM-dd HH:mm'}" Grid.Column="1" Style="{StaticResource InfoStyle}"/>
                </DataTemplate>
            </DataGridTemplateColumn.CellTemplate>
        </DataGridTemplateColumn>

        <DataGridTemplateColumn Header="执行信息">
            <DataGridTemplateColumn.CellTemplate >
                <DataTemplate>
                    <Grid Visibility="{Binding Converter={x:Static js:Converters.BooleanToVisibility},Path=PerformExecTimeStatus.IsPerform}">
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition MinWidth="30" Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="执行时间" Style="{StaticResource LabelStyle}" Visibility="{Binding Converter={StaticResource NullEmptyToVisibilityConverter}, Path=CompleteTime}"/>
                        <TextBlock Text="{Binding CompleteTime ,StringFormat='yyyy-MM-dd HH:mm'}" Grid.Column="1" Style="{StaticResource InfoStyle}" Visibility="{Binding Converter={StaticResource NullEmptyToVisibilityConverter}, Path=CompleteTime}"/>
                        <TextBlock Text="执行者" Grid.Row="1" Style="{StaticResource LabelStyle}" Visibility="{Binding Converter={StaticResource NullEmptyToVisibilityConverter}, Path=ExecTimeExecutorName}"/>
                        <TextBlock Text="{Binding ExecTimeExecutorName}" Grid.Row="1" Grid.Column="1"  Style="{StaticResource InfoStyle}" Visibility="{Binding Converter={StaticResource NullEmptyToVisibilityConverter}, Path=ExecTimeExecutorName}"/>
                    </Grid>
                </DataTemplate>
            </DataGridTemplateColumn.CellTemplate>
        </DataGridTemplateColumn>
        <DataGridTemplateColumn Header="退药信息" >
            <DataGridTemplateColumn.CellTemplate >
                <DataTemplate>
                    <Grid>
                        <Grid.RowDefinitions>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                            <RowDefinition Height="Auto"/>
                        </Grid.RowDefinitions>
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="Auto"/>
                            <ColumnDefinition MinWidth="50" Width="Auto"/>
                        </Grid.ColumnDefinitions>
                        <TextBlock Text="退药时间" Style="{StaticResource LabelStyle}" Visibility="{Binding Converter={x:Static js:Converters.BooleanToVisibility}, Path=HasWithDrawal}"/>
                        <TextBlock Text="{Binding WithDrawalDateTime,StringFormat='yyyy-MM-dd HH:mm'}" Grid.Column="1" Style="{StaticResource InfoStyle}" Visibility="{Binding Converter={x:Static js:Converters.BooleanToVisibility}, Path=HasWithDrawal}"/>
                        <TextBlock Text="退药人" Grid.Row="1" Style="{StaticResource LabelStyle}" Margin="4,0" Visibility="{Binding Converter={x:Static js:Converters.BooleanToVisibility}, Path=HasWithDrawal}"/>
                        <TextBlock Text="{Binding WithDrawalEmployeeName}" Grid.Row="1" Grid.Column="1" Style="{StaticResource InfoStyle}" Visibility="{Binding Converter={x:Static js:Converters.BooleanToVisibility}, Path=HasWithDrawal}"/>
                        <TextBlock Text="退药状态" Grid.Row="2" Style="{StaticResource LabelStyle}" Visibility="{Binding Converter={x:Static js:Converters.BooleanToVisibility}, Path=HasWithDrawal}"/>
                        <TextBlock Text="{Binding WithDrawalStatus}" Grid.Row="2" Grid.Column="1"  Style="{StaticResource InfoStyle}" Visibility="{Binding Converter={x:Static js:Converters.BooleanToVisibility}, Path=HasWithDrawal}"/>
                    </Grid>
                </DataTemplate>
            </DataGridTemplateColumn.CellTemplate>
        </DataGridTemplateColumn>
    </DataGrid.Columns>
</DataGrid>